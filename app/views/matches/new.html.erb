<% content_for :title, "새 경기 만들기 - #{@club.name}" %>

<div class="max-w-7xl mx-auto">
  <!-- 뒤로가기 -->
  <div class="mb-4">
    <%= link_to club_matches_path(@club), class: "btn btn-ghost btn-sm gap-2" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      뒤로가기
    <% end %>
  </div>

  <!-- 페이지 헤더 -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-base-content mb-2">새 경기 만들기</h1>
    <p class="text-base-content/60">선수를 선택하고 팀 밸런싱을 진행합니다</p>
  </div>

  <!-- 폼 카드 -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <%= form_with model: [@club, @match], local: true, class: "space-y-6" do |form| %>

        <!-- 기본 정보 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control w-full">
            <%= form.label :played_on, "경기 날짜", class: "label" %>
            <%= form.date_field :played_on,
                required: true,
                class: "input input-bordered w-full" %>
          </div>

          <div class="form-control w-full col-span-1 md:col-span-2">
            <%= form.label :teams_count, "팀 수 선택", class: "label" %>
            <div class="grid grid-cols-2 gap-10">
              <% [2, 3].each do |count| %>
                <label class="cursor-pointer group">
                  <%= form.radio_button :teams_count, count, class: "hidden peer", required: true %>
                  <div class="card bg-base-200 peer-checked:bg-primary peer-checked:text-primary-content hover:bg-base-300 peer-checked:hover:bg-primary transition-all duration-200 text-center py-6 border-2 border-transparent peer-checked:border-primary shadow-sm peer-checked:shadow-lg peer-checked:scale-105">
                    <span class="text-2xl font-bold"><%= count %>팀</span>
                    <span class="text-xs opacity-60 mt-1 block font-medium"><%= count == 2 ? "A vs B" : "리그전 (A/B/C)" %></span>
                  </div>
                </label>
              <% end %>
            </div>
          </div>
        </div>

        <!-- 메모 -->
        <div class="form-control w-full">
          <%= form.label :note, "메모", class: "label" %>
          <%= form.text_field :note,
              placeholder: "예: 2월 정기 경기",
              class: "input input-bordered w-full" %>
        </div>

        <!-- 팀 설정 (이름 & 색상) -->
        <div class="form-control w-full">
          <label class="label">
            <span class="label-text font-medium text-lg">팀 설정</span>
            <span class="label-text-alt text-base-content/60">이름과 색상을 지정하세요</span>
          </label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <% labels = %w[A B C] %>
            <% 3.times do |index| %>
              <div class="card bg-base-200 border border-base-300">
                <div class="card-body p-4">
                  <h3 class="font-bold text-sm mb-2 opacity-50">TEAM <%= labels[index] %></h3>
                  
                  <!-- 팀/색상 설정 -->
                  <div class="form-control mb-3">
                    <label class="label py-0 mb-1"><span class="label-text text-xs">팀 이름</span></label>
                    <input type="text" name="team_names[]" placeholder="팀 <%= labels[index] %>" class="input input-sm input-bordered w-full" value="<%= labels[index] %>">
                  </div>

                  <div class="form-control">
                    <label class="label py-0 mb-1"><span class="label-text text-xs">팀 색상</span></label>
                    
                    <!-- 색상 선택 트리거 버튼 -->
                    <button type="button" class="btn btn-sm btn-outline w-full justify-center gap-2 border-base-content/20 font-normal" onclick="document.getElementById('color_modal_<%= index %>').showModal()">
                      <div class="w-6 h-6 rounded-full bg-current border border-base-content/10" style="background-color: <%= Team::COLORS[index] %>" id="color-preview-<%= index %>"></div>
                    </button>

                    <!-- 색상 선택 모달 -->
                    <dialog id="color_modal_<%= index %>" class="modal modal-bottom sm:modal-middle" onclick="if(event.target === this) this.close()">
                      <div class="modal-box">
                        <h3 class="font-bold text-lg mb-4 text-center">팀 <%= labels[index] %> 색상 선택</h3>
                        
                        <div class="grid grid-cols-5 gap-4 justify-items-center py-4">
                          <% Team::COLORS.each do |color| %>
                            <label class="cursor-pointer color-option flex items-center justify-center p-1" data-color="<%= color %>" data-team-index="<%= index %>">
                              <input type="radio" name="team_colors[<%= index %>]" value="<%= color %>" class="hidden peer" 
                                     <%= "checked" if Team::COLORS[index] == color %>
                                     onchange="handleColorChangeOnly(this, <%= index %>)">
                              <div class="w-12 h-12 rounded-full border-4 border-transparent peer-checked:border-primary peer-checked:scale-110 shadow-sm transition-transform hover:scale-105 peer-disabled:opacity-20 peer-disabled:cursor-not-allowed" 
                                   style="background-color: <%= color %>"></div>
                            </label>
                          <% end %>
                        </div>

                        <div class="modal-action">
                          <button type="button" class="btn btn-block" onclick="this.closest('dialog').close()">닫기</button>
                        </div>
                      </div>
                    </dialog>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- 참가 멤버 선택 -->
        <div class="form-control w-full">
          <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
            <label class="label p-0">
              <span class="label-text font-medium text-lg">참가 멤버 선택</span>
              <span class="label-text-alt ml-2">총 <span id="member-count"><%= @members.count %></span>명</span>
            </label>
            
            <div class="flex items-center gap-2">
              <button type="button" class="btn btn-sm btn-ghost text-error" onclick="selectTopMembers(0)">
                전체 해제
              </button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="selectTopMembers(18)">
                상위 18명 선택
              </button>
            </div>
          </div>
          
          <!-- 정렬 컨트롤 -->
          <div class="flex flex-wrap items-center gap-2 mb-4 p-2 bg-base-200 rounded-lg justify-end">
            <span class="text-xs font-bold opacity-50 px-2 mr-auto">정렬:</span>
            <button type="button" class="btn btn-ghost btn-xs gap-1 w-24" data-sort="name">이름</button>
            <button type="button" class="btn btn-ghost btn-xs gap-1 w-24" data-sort="position">포지션</button>
            <button type="button" class="btn btn-ghost btn-xs gap-1 w-24" data-sort="height">키</button>
            <button type="button" class="btn btn-ghost btn-xs gap-1 w-24" data-sort="winrate">승률</button>
            <button type="button" class="btn btn-ghost btn-xs gap-1 w-24" data-sort="games">경기수</button>
            <button type="button" class="btn btn-ghost btn-xs gap-1 w-24" data-sort="jersey">등번호</button>
          </div>

          <% if @members.any? %>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 p-4 bg-base-200 rounded-box min-h-[500px] content-start" id="member-list">
              <% @members.each do |member| %>
                <% stats = @member_stats[member.id] || { games: 0, win_rate: 0.0 } %>
                <label class="cursor-pointer member-item group" 
                       data-member-id="<%= member.id %>"
                       data-name="<%= member.name %>"
                       data-position="<%= member.position %>"
                       data-jersey="<%= member.jersey_number || 999 %>"
                       data-height="<%= member.height_cm || 0 %>"
                       data-winrate="<%= stats[:win_rate] %>"
                       data-games="<%= stats[:games] %>">
                  <input type="checkbox" name="member_ids[]" value="<%= member.id %>" class="hidden peer">
                  <div class="card bg-base-100 peer-checked:bg-primary peer-checked:text-primary-content transition-all duration-200 peer-checked:ring-2 peer-checked:ring-primary h-full hover:shadow-md">
                    <div class="card-body p-3">
                      <div class="flex justify-between items-start">
                        <div class="font-medium truncate text-sm"><%= member.name %></div>
                        <% if member.jersey_number %>
                          <span class="text-xs opacity-50 group-hover:opacity-100 font-mono">#<%= member.jersey_number %></span>
                        <% end %>
                      </div>
                      
                      <div class="flex items-center gap-1 mt-1 flex-wrap">
                        <span class="badge badge-xs text-white border-none" style="<%= position_badge_style(member.position) %>">
                          <%= member.position %>
                        </span>
                        <% if member.height_cm %>
                          <span class="text-[10px] opacity-70 bg-base-200 px-1 rounded text-base-content"><%= member.height_cm %>cm</span>
                        <% end %>
                      </div>
                      
                      <!-- 승률 및 경기수 표시 -->
                      <div class="mt-2 pt-2 border-t border-base-content/10 flex justify-between items-end text-xs">
                        <div class="flex flex-col">
                          <span class="text-[10px] opacity-60">승률</span>
                          <span class="font-bold font-mono <%= 'text-primary' if stats[:win_rate] >= 0.5 %>"><%= (stats[:win_rate] * 100).round(0) %>%</span>
                        </div>
                        <div class="flex flex-col text-right">
                          <span class="text-[10px] opacity-60">경기수</span>
                          <span class="font-bold"><%= stats[:games] %></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </label>
              <% end %>
            </div>
          <% else %>
            <div class="alert alert-warning">
              <span>멤버가 없습니다.</span>
            </div>
          <% end %>
        </div>

        <!-- 제출 버튼 -->
        <div class="form-control mt-8">
          <%= form.submit "팀 생성하기", class: "btn btn-primary btn-lg w-full gap-2" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
// 포지션 정렬 순서
const POSITION_ORDER = { "PG": 1, "SG": 2, "SF": 3, "PF": 4, "C": 5 };

document.addEventListener("DOMContentLoaded", function() {
  updateColorAvailability();
  setupSorting();
});

function handleColorChangeOnly(input, teamIndex) {
  const color = input.value;
  // 미리보기 업데이트
  const preview = document.getElementById(`color-preview-${teamIndex}`);
  if (preview) preview.style.backgroundColor = color;
  
  // 모달 닫기
  const modal = document.getElementById(`color_modal_${teamIndex}`);
  if (modal) modal.close();
  
  // 다른 팀에서 이 색상 비활성화 처리
  updateColorAvailability();
}

function updateColorAvailability() {
  // 현재 선택된 색상들 수집
  const selectedColors = {};
  document.querySelectorAll('input[name^="team_colors"]:checked').forEach(input => {
    // name="team_colors[0]" -> index 0
    const match = input.name.match(/\[(\d+)\]/);
    if (match) {
      selectedColors[match[1]] = input.value;
    }
  });

  // 모든 옵션 순회하며 비활성화 처리
  document.querySelectorAll('.color-option input[type="radio"]').forEach(input => {
    const parentLabel = input.closest('label');
    const myTeamIndex = parentLabel.dataset.teamIndex;
    const myColor = parentLabel.dataset.color;
    
    let disabled = false;
    // 다른 팀이 선택한 색상이면 비활성화 (내 팀이 선택한 건 제외)
    for (const [teamIdx, color] of Object.entries(selectedColors)) {
      if (teamIdx !== myTeamIndex && color === myColor) {
        disabled = true;
        break;
      }
    }
    
    input.disabled = disabled;
    
    // 시각적 피드백
    const colorCircle = parentLabel.querySelector('div');
    if (disabled) {
      parentLabel.classList.add('opacity-20', 'cursor-not-allowed');
      colorCircle.classList.add('opacity-20');
    } else {
      parentLabel.classList.remove('opacity-20', 'cursor-not-allowed');
      colorCircle.classList.remove('opacity-20');
    }
  });
}

function selectTopMembers(count) {
  const checkboxes = document.querySelectorAll('input[name="member_ids[]"]');
  // 현재 화면에 보이는 순서대로 체크
  const items = Array.from(document.querySelectorAll('.member-item'));
  
  items.forEach((item, index) => {
    const checkbox = item.querySelector('input[type="checkbox"]');
    checkbox.checked = index < count;
  });
}

function setupSorting() {
  const memberList = document.getElementById("member-list");
  if (!memberList) return;

  const sortState = {};
  const sortButtons = document.querySelectorAll("[data-sort]");

  sortButtons.forEach(btn => {
    btn.addEventListener("click", function() {
      const sortKey = this.dataset.sort;
      
      // Default directions
      if (!sortState[sortKey]) {
        if (sortKey === "name" || sortKey === "position") sortState[sortKey] = "asc";
        else sortState[sortKey] = "desc"; // Stats default to desc
      } else {
        // Toggle
        sortState[sortKey] = sortState[sortKey] === "asc" ? "desc" : "asc";
      }
      
      const items = Array.from(memberList.querySelectorAll(".member-item"));

      items.sort((a, b) => {
        let aVal = a.dataset[sortKey];
        let bVal = b.dataset[sortKey];

        // Type conversion & Custom Logic
        if (sortKey === "position") {
          aVal = POSITION_ORDER[aVal] || 99;
          bVal = POSITION_ORDER[bVal] || 99;
        } else if (sortKey === "height" || sortKey === "games" || sortKey === "member-id" || sortKey === "jersey") {
          aVal = parseInt(aVal) || 0;
          bVal = parseInt(bVal) || 0;
        } else if (sortKey === "winrate") {
          aVal = parseFloat(aVal) || 0.0;
          bVal = parseFloat(bVal) || 0.0;
        }

        if (aVal === bVal) return 0;
        
        const modifier = sortState[sortKey] === "asc" ? 1 : -1;
        return aVal > bVal ? modifier : -modifier;
      });

      items.forEach(item => memberList.appendChild(item));

      // Update UI
      sortButtons.forEach(b => {
        b.classList.remove("btn-active", "btn-primary", "text-primary-content");
        // Reset text
        const text = b.textContent.trim().split(" ")[0]; 
        b.innerHTML = text;
      });
      
      this.classList.add("btn-active", "btn-primary", "text-primary-content");
      const arrow = sortState[sortKey] === "asc" ? "↑" : "↓";
      this.innerHTML += ` <span class="ml-1">${arrow}</span>`;
    });
  });
}
</script>
