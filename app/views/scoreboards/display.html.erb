<%# New Basketball Scoreboard Display %>
<div id="scoreboard-root"
     class="w-full h-screen flex flex-col bg-[#0B1120] overflow-hidden select-none relative"
     data-scoreboard-root
     data-scoreboard-role="display"
     data-match-id="<%= @match.id %>"
     data-teams="<%= @match.teams.respond_to?(:map) ? @match.teams.map { |t| { id: t.id, label: t.respond_to?(:label) ? t.label : t.name, name: t.name, color: t.color, icon: t.respond_to?(:icon) ? t.icon : 'üèÄ', score: 0 } }.to_json : @match.teams.to_json %>"
     data-games="<%= @games_for_scoreboard.to_json %>"
     data-teams-count="<%= @match.teams.count %>"
     data-regular-quarters="<%= @match.respond_to?(:regular_quarters) ? @match.regular_quarters : 4 %>"
     data-default-period-seconds="<%= current_user.default_period_seconds %>"
     data-locale="<%= current_locale %>"
     data-voice-lang="<%= current_user.speech_locale %>"
     data-sound-enabled="<%= current_user.scoreboard_sound_enabled %>"
     data-voice-enabled="<%= current_user.voice_announcement_enabled %>"
     data-voice-rate="<%= current_user.voice_announcement_rate %>"
     data-possession-switch-pattern="<%= current_user.possession_switch_pattern %>">

  <%# Header Bar %>
  <header class="h-28 bg-[#131B2E] flex items-center justify-between px-12 border-b border-gray-700">
    <%# LIVE Indicator %>
    <div class="flex items-center space-x-2">
      <div class="w-6 h-6 rounded-full bg-red-500 animate-pulse"></div>
      <span class="text-red-500 font-bold tracking-wider text-2xl">LIVE</span>
    </div>

    <%# Center Title %>
    <div class="absolute left-1/2 transform -translate-x-1/2">
      <span class="text-gray-400 font-semibold tracking-[0.2em] text-2xl uppercase">Basketball</span>
    </div>

    <%# Quarter Badge, Size Controls & Fullscreen Button %>
    <div class="flex items-center space-x-4">
      <div class="bg-gray-700 text-gray-200 text-2xl font-bold px-8 py-4 rounded shadow-lg uppercase tracking-wider">
        <span data-scoreboard-quarter>1</span>Q
      </div>
      <%# Text Size Controls %>
      <div class="flex items-center space-x-2 bg-gray-800 rounded-lg px-3 py-2">
        <button id="size-decrease-btn" class="w-10 h-10 bg-gray-700 hover:bg-gray-600 text-white text-xl font-bold rounded transition-colors flex items-center justify-center" title="<%= t('scoreboard.size_decrease', default: 'Í∏ÄÏûê Ï∂ïÏÜå') %>">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 12H4" /></svg>
        </button>
        <span class="text-gray-400 text-sm font-bold px-2" data-size-indicator>100%</span>
        <button id="size-increase-btn" class="w-10 h-10 bg-gray-700 hover:bg-gray-600 text-white text-xl font-bold rounded transition-colors flex items-center justify-center" title="<%= t('scoreboard.size_increase', default: 'Í∏ÄÏûê ÌôïÎåÄ') %>">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
        </button>
      </div>
      <button id="fullscreen-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold px-8 py-4 rounded transition-colors uppercase tracking-wide shadow-lg">
        <span data-ui-key="fullscreen">Full Screen</span>
      </button>
    </div>
  </header>

  <%# Main Content Area %>
  <div class="flex-1 relative flex flex-col">
    <div class="flex-1 flex items-center justify-center relative p-8">

      <%# Left Team %>
      <div class="flex-1 flex flex-col items-center justify-center">
        <%# Team Name with Color Bar %>
        <div class="flex flex-col items-center mb-2">
          <div class="flex flex-col items-center">
            <div class="flex items-center space-x-3 mb-2">
              <div class="w-8 h-8 rounded-full team-color-indicator-left" style="background-color: #3b82f6;" data-team-color-left></div>
              <h2 class="text-white text-4xl md:text-5xl font-bold tracking-wider uppercase" data-team-name-left>TEAM A</h2>
            </div>
            <div class="h-2 w-full rounded-full team-color-bar-left" style="background-color: #3b82f6;" data-team-bar-left></div>
          </div>
        </div>

        <%# Score %>
        <div class="text-[#FF6B00] font-black text-score tracking-wide tabular-nums drop-shadow-lg" data-score-left>0</div>

        <%# Fouls %>
        <div class="mt-8 flex flex-col items-center space-y-4">
          <div class="flex items-center space-x-4">
            <span class="text-gray-400 text-xl font-bold tracking-widest uppercase" data-ui-key="foul">Fouls</span>
            <div class="flex space-x-2" data-foul-indicators-left>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="0"></div>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="1"></div>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="2"></div>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="3"></div>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="4"></div>
            </div>
          </div>
          <span class="text-red-500 font-bold text-3xl md:text-4xl uppercase tracking-wider hidden" data-team-foul-badge-left>TEAM FOUL</span>
        </div>
      </div>

      <%# Center Section - Clock, Possession, Shot Clock %>
      <div class="w-1/4 flex flex-col items-center justify-start h-full pt-10 space-y-8">
        <%# Game Clock %>
        <div class="text-center">
          <span class="text-gray-400 text-xl font-bold tracking-[0.15em] uppercase mb-4 block" data-ui-key="game_clock_label">Game Clock</span>
          <div class="text-white font-bold text-clock tracking-tight leading-none" data-scoreboard-timer>10:00</div>
        </div>

        <%# Possession Indicator %>
        <div class="flex items-center space-x-6" data-possession-indicator>
          <div class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center transition-all duration-300 possession-arrow-left">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-gray-500 rotate-180" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
          </div>
          <span class="text-gray-400 text-lg font-bold tracking-widest uppercase"><%= t('settings.possession.title', default: 'Possession') %></span>
          <div class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center transition-all duration-300 possession-arrow-right">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
          </div>
        </div>

        <%# Shot Clock %>
        <div class="flex flex-col items-center w-full">
          <span class="text-gray-400 text-xl font-bold tracking-[0.15em] uppercase mb-6" data-ui-key="shot_clock_label">Shot Clock</span>
          <div class="border border-gray-700 bg-[#131B2E]/30 rounded-xl px-16 py-6 w-full max-w-[450px] flex justify-center">
            <span class="text-[#39FF14] font-bold text-[160px] md:text-[200px] tabular-nums leading-none" data-scoreboard-shot>24</span>
          </div>
        </div>
      </div>

      <%# Right Team %>
      <div class="flex-1 flex flex-col items-center justify-center">
        <%# Team Name with Color Bar %>
        <div class="flex flex-col items-center mb-2">
          <div class="flex flex-col items-center">
            <div class="flex items-center space-x-3 mb-2">
              <div class="w-8 h-8 rounded-full team-color-indicator-right" style="background-color: #ef4444;" data-team-color-right></div>
              <h2 class="text-white text-4xl md:text-5xl font-bold tracking-wider uppercase" data-team-name-right>TEAM B</h2>
            </div>
            <div class="h-2 w-full rounded-full team-color-bar-right" style="background-color: #ef4444;" data-team-bar-right></div>
          </div>
        </div>

        <%# Score %>
        <div class="text-[#FF6B00] font-black text-score tracking-wide tabular-nums drop-shadow-lg" data-score-right>0</div>

        <%# Fouls %>
        <div class="mt-8 flex flex-col items-center space-y-4">
          <div class="flex items-center space-x-4">
            <span class="text-gray-400 text-xl font-bold tracking-widest uppercase" data-ui-key="foul">Fouls</span>
            <div class="flex space-x-2" data-foul-indicators-right>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="0"></div>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="1"></div>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="2"></div>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="3"></div>
              <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-red-500" data-foul-circle="4"></div>
            </div>
          </div>
          <span class="text-red-500 font-bold text-3xl md:text-4xl uppercase tracking-wider hidden" data-team-foul-badge-right>TEAM FOUL</span>
        </div>
      </div>

    </div>

    <%# Sponsor Banner Area %>
    <div class="h-auto bg-[#131B2E] border-t border-gray-700 py-6 px-12">
      <div class="flex gap-8 justify-center">
        <div class="bg-white rounded-xl p-6 flex items-center justify-center shadow-lg w-72 h-28 flex-shrink-0">
          <img src="/manpo.png?v=<%= Time.now.to_i %>" alt="ÎßåÌè¨Î©¥Ïò•" class="h-20 object-contain">
        </div>
        <div class="bg-white rounded-xl p-6 flex items-center justify-center shadow-lg w-72 h-28 flex-shrink-0">
          <img src="/hongkong.png?v=<%= Time.now.to_i %>" alt="ÌôçÏΩ©Î∞òÏ†ê" class="h-20 object-contain">
        </div>
        <div class="bg-white rounded-xl p-6 flex items-center justify-center shadow-lg w-72 h-28 flex-shrink-0">
          <img src="/mapo-YC.png?v=<%= Time.now.to_i %>" alt="ÏãúÎ¶ΩÎßàÌè¨Ï≤≠ÏÜåÎÖÑÏÑºÌÑ∞" class="h-20 object-contain">
        </div>
      </div>
    </div>
  </div>

</div>

<style>
  /* === ÌÖçÏä§Ìä∏ ÏÇ¨Ïù¥Ï¶à Ï°∞Ï†àÏö© CSS Î≥ÄÏàò === */
  :root {
    --display-scale: 1;
  }

  /* === Ïä§ÏΩîÏñ¥Î≥¥Îìú ÌÖçÏä§Ìä∏ Ïä§ÌÉÄÏùº === */
  .text-score {
    font-size: calc(clamp(10rem, 22vw, 18rem) * var(--display-scale));
    line-height: 1;
  }

  .text-clock {
    font-size: calc(clamp(6rem, 12vw, 10rem) * var(--display-scale));
    line-height: 1;
  }

  [data-scoreboard-shot] {
    font-size: calc(clamp(8rem, 18vw, 14rem) * var(--display-scale)) !important;
  }

  /* FORCE possession arrows to always be visible (override main JS hidden class) */
  .possession-arrow-left,
  .possession-arrow-right {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    background-color: #374151; /* gray-700 */
    transition: all 0.3s ease;
  }

  .possession-arrow-left svg,
  .possession-arrow-right svg {
    color: #6B7280; /* gray-500 */
    transition: color 0.3s ease;
  }

  /* Active possession - red circle with white arrow */
  .possession-arrow-left.active,
  .possession-arrow-right.active {
    background-color: #ef4444 !important;
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
  }

  .possession-arrow-left.active svg,
  .possession-arrow-right.active svg {
    color: white !important;
  }

  /* Team foul badge animation */
  [data-team-foul-badge-left]:not(.hidden),
  [data-team-foul-badge-right]:not(.hidden) {
    animation: foul-pulse 1s ease-in-out infinite;
  }

  @keyframes foul-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const arrowLeft = document.querySelector('.possession-arrow-left');
    const arrowRight = document.querySelector('.possession-arrow-right');

    // Track current possession state
    let currentPossession = null;

    // === ÌåÄ ÏÉâÏÉÅ Îß§Ìïë (Team::COLORS ‚Üí CSS ÏÉâÏÉÅ) ===
    const TEAM_COLOR_MAP = {
      'White': '#ffffff',
      'Black': '#1f2937',
      'Red': '#ef4444',
      'Blue': '#3b82f6',
      'Yellow': '#eab308',
      'Green': '#22c55e',
      'Pink': '#ec4899',
      'SkyBlue': '#38bdf8',
      'Brown': '#a16207',
      'Orange': '#f97316'
    };

    // ÌåÄ ÏÉâÏÉÅ Ïù¥Î¶ÑÏùÑ CSS ÏÉâÏÉÅÏúºÎ°ú Î≥ÄÌôò
    const getTeamColor = (colorName) => {
      return TEAM_COLOR_MAP[colorName] || colorName || '#3b82f6';
    };

    // === ÌÖçÏä§Ìä∏ ÏÇ¨Ïù¥Ï¶à Ï°∞Ï†à ===
    const SCALE_MIN = 0.6;
    const SCALE_MAX = 1.4;
    const SCALE_STEP = 0.1;
    let currentScale = parseFloat(localStorage.getItem('scoreboard-display-scale') || '1');

    const sizeIndicator = document.querySelector('[data-size-indicator]');
    const decreaseBtn = document.getElementById('size-decrease-btn');
    const increaseBtn = document.getElementById('size-increase-btn');

    const updateScale = (newScale) => {
      currentScale = Math.max(SCALE_MIN, Math.min(SCALE_MAX, newScale));
      document.documentElement.style.setProperty('--display-scale', currentScale);
      if (sizeIndicator) {
        sizeIndicator.textContent = Math.round(currentScale * 100) + '%';
      }
      localStorage.setItem('scoreboard-display-scale', currentScale.toString());
      console.log('[Display] Scale updated:', currentScale);
    };

    if (decreaseBtn) {
      decreaseBtn.addEventListener('click', () => updateScale(currentScale - SCALE_STEP));
    }
    if (increaseBtn) {
      increaseBtn.addEventListener('click', () => updateScale(currentScale + SCALE_STEP));
    }

    // Ï¥àÍ∏∞ Ïä§ÏºÄÏùº Ï†ÅÏö©
    updateScale(currentScale);

    // Apply visual styles directly (bypass CSS class issues)
    const applyArrowStyles = (arrow, isActive) => {
      if (!arrow) return;
      const icon = arrow.querySelector('svg');

      if (isActive) {
        arrow.style.backgroundColor = '#ef4444';
        arrow.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.5)';
        if (icon) icon.style.color = 'white';
      } else {
        arrow.style.backgroundColor = '#374151';
        arrow.style.boxShadow = 'none';
        if (icon) icon.style.color = '#6B7280';
      }
    };

    // Function to update arrow active states
    const updatePossessionArrows = (possession) => {
      console.log('[Display] Updating possession arrows:', possession);

      // Display page is mirrored from control page
      // Control: left=away, right=home
      // Display: left=home, right=away (reversed)
      // So possession='home' means left arrow active on display
      if (possession === 'home') {
        applyArrowStyles(arrowLeft, true);
        applyArrowStyles(arrowRight, false);
      } else if (possession === 'away') {
        applyArrowStyles(arrowLeft, false);
        applyArrowStyles(arrowRight, true);
      } else {
        // No possession - both gray
        applyArrowStyles(arrowLeft, false);
        applyArrowStyles(arrowRight, false);
      }
    };

    // Listen for scoreboard updates to handle new design-specific elements
    document.addEventListener('scoreboard:updated', (e) => {
      const { state } = e.detail;
      if (!state) return;

      console.log('[Display] scoreboard:updated received, possession:', state.possession);

      // Update possession arrows (always update, not just on change)
      currentPossession = state.possession;
      // Use setTimeout to ensure this runs after main JS
      setTimeout(() => updatePossessionArrows(state.possession), 50);

      // Team colors are now handled by application.js render() function
      // with setProperty(..., 'important') for proper CSS specificity

      // Update team foul badges (show when fouls >= 5)
      // On display: left = away_fouls, right = home_fouls
      const leftFouls = state.away_fouls || 0;
      const rightFouls = state.home_fouls || 0;

      const leftBadge = document.querySelector('[data-team-foul-badge-left]');
      const rightBadge = document.querySelector('[data-team-foul-badge-right]');

      if (leftBadge) {
        if (leftFouls >= 5) {
          leftBadge.classList.remove('hidden');
        } else {
          leftBadge.classList.add('hidden');
        }
      }

      if (rightBadge) {
        if (rightFouls >= 5) {
          rightBadge.classList.remove('hidden');
        } else {
          rightBadge.classList.add('hidden');
        }
      }
    });

    // Initial state - both gray
    applyArrowStyles(arrowLeft, false);
    applyArrowStyles(arrowRight, false);

    console.log('[Display] Possession arrows initialized');
    console.log('[Display] Team color mapping enabled');
  });
</script>
