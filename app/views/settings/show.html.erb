<% content_for :title, "세팅" %>

<div class="max-w-5xl mx-auto">
  <div class="mb-6">
    <h1 class="text-4xl font-bold text-base-content mb-2">세팅</h1>
    <p class="text-base-content/60">점수판 기본 설정을 관리합니다.</p>
  </div>

  <div class="card bg-base-100 shadow-xl border border-base-300">
    <div class="card-body p-6 md:p-8">
      <%= form_with model: @user, url: setting_path, method: :patch, local: true, class: "space-y-6", data: { settings_form: true } do |form| %>
        <%= form.hidden_field :default_game_minutes, data: { minute_input: true } %>

        <section class="rounded-2xl border border-base-300 bg-base-100 p-5 md:p-6">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h2 class="text-2xl font-bold text-base-content">경기 시간 설정</h2>
              <p class="text-base-content/60 mt-1">설정한 시간이 새 점수판의 기본 경기 시간으로 적용됩니다.</p>
            </div>
            <div class="badge badge-neutral badge-lg gap-1 shrink-0">
              현재 기본 <span data-minute-preview class="font-bold"><%= @user.default_game_minutes %></span>분
            </div>
          </div>

          <div class="mt-5 grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4">
            <div class="rounded-xl border border-base-300 bg-base-200/40 p-4">
              <p class="font-semibold text-base-content mb-3">기본 경기 시간</p>

              <div class="join w-full">
                <button type="button" class="btn btn-outline join-item px-4" data-minute-adjust="-1">-1</button>
                <button type="button" class="btn btn-outline join-item px-4" data-minute-adjust="1">+1</button>
                <div class="join-item btn btn-outline flex-1 cursor-default pointer-events-none bg-base-100 justify-center gap-1 normal-case">
                  <span data-minute-display class="text-3xl md:text-4xl font-black tabular-nums leading-none"><%= @user.default_game_minutes %></span>
                  <span class="text-sm text-base-content/60 font-semibold">분</span>
                </div>
              </div>

              <p class="text-sm text-base-content/60 mt-3">허용 범위: <%= User::MIN_GAME_MINUTES %>~<%= User::MAX_GAME_MINUTES %>분</p>
              <% if @user.errors[:default_game_minutes].any? %>
                <p class="text-error text-sm mt-2"><%= @user.errors[:default_game_minutes].join(", ") %></p>
              <% end %>
            </div>

            <div class="rounded-xl border border-base-300 bg-base-200/40 p-4">
              <p class="font-semibold text-base-content mb-3">빠른 시간 선택</p>
              <div class="flex flex-wrap gap-2">
                <% [6, 7, 8, 9, 10, 11, 12].each do |minute| %>
                  <button type="button" class="btn btn-outline" data-minute-preset="<%= minute %>">
                    <%= minute %>분
                  </button>
                <% end %>
              </div>
              <p class="text-sm text-base-content/60 mt-3">자주 쓰는 시간을 빠르게 적용할 수 있습니다.</p>
            </div>
          </div>
        </section>

        <section class="rounded-2xl border border-base-300 bg-base-100 p-5 md:p-6">
          <div class="mb-4">
            <h3 class="text-xl font-bold">사운드/음성 설정</h3>
            <p class="text-base-content/60 mt-1">현장 운영 환경에 맞게 안내 기능을 켜거나 끌 수 있습니다.</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-center justify-between gap-4 hover:border-primary/40 transition-colors">
              <div>
                <p class="font-semibold">점수판 사운드</p>
                <p class="text-sm text-base-content/60">버저 효과음을 재생합니다.</p>
              </div>
              <div class="flex items-center gap-2">
                <span id="sound-status" class="badge badge-sm">ON</span>
                <%= form.check_box :scoreboard_sound_enabled, { class: "toggle toggle-primary", data: { setting_toggle: true, status_target: "sound-status" } }, "1", "0" %>
              </div>
            </label>

            <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-center justify-between gap-4 hover:border-primary/40 transition-colors">
              <div>
                <p class="font-semibold">음성 안내</p>
                <p class="text-sm text-base-content/60">카운트다운과 점수 음성 안내를 재생합니다.</p>
              </div>
              <div class="flex items-center gap-2">
                <span id="voice-status" class="badge badge-sm">ON</span>
                <%= form.check_box :voice_announcement_enabled, { class: "toggle toggle-primary", data: { setting_toggle: true, status_target: "voice-status" } }, "1", "0" %>
              </div>
            </label>
          </div>
        </section>

        <section class="rounded-2xl border border-base-300 bg-base-100 p-5 md:p-6">
          <div class="mb-4">
            <h3 class="text-xl font-bold">공격방향 전환 설정</h3>
            <p class="text-base-content/60 mt-1">쿼터 진행 시 공격방향 자동 전환 규칙을 선택합니다.</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-start gap-3 hover:border-primary/40 transition-colors">
              <%= form.radio_button :possession_switch_pattern, "q12_q34", class: "radio radio-primary mt-1" %>
              <div>
                <p class="font-semibold">1,2쿼터 / 3,4쿼터 전환</p>
                <p class="text-sm text-base-content/60 mt-1">전반(1·2Q) 동일, 후반(3·4Q)에서 방향을 바꿉니다.</p>
              </div>
            </label>

            <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-start gap-3 hover:border-primary/40 transition-colors">
              <%= form.radio_button :possession_switch_pattern, "q13_q24", class: "radio radio-primary mt-1" %>
              <div>
                <p class="font-semibold">1,3쿼터 / 2,4쿼터 전환</p>
                <p class="text-sm text-base-content/60 mt-1">쿼터마다 번갈아 공격방향을 자동 전환합니다.</p>
              </div>
            </label>
          </div>
        </section>

        <div class="flex items-center gap-3">
          <%= form.submit "저장하기", class: "btn btn-primary px-7" %>
          <%= link_to "취소", clubs_path, class: "btn btn-ghost" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  (() => {
    const bindSettingsUI = () => {
      const form = document.querySelector("[data-settings-form]");
      if (!form || form.dataset.settingsUiBound === "true") return;
      form.dataset.settingsUiBound = "true";

      const minuteInput = form.querySelector("[data-minute-input]");
      const minutePreview = form.querySelector("[data-minute-preview]");
      const minuteDisplay = form.querySelector("[data-minute-display]");
      const presetButtons = Array.from(form.querySelectorAll("[data-minute-preset]"));
      if (!minuteInput) return;

      const min = <%= User::MIN_GAME_MINUTES %>;
      const max = <%= User::MAX_GAME_MINUTES %>;

      const clamp = (value) => Math.max(min, Math.min(max, value));
      const readMinutes = () => clamp(Number.parseInt(minuteInput.value || `${min}`, 10) || min);

      const refreshPresetState = (minuteValue) => {
        presetButtons.forEach((button) => {
          const preset = Number.parseInt(button.dataset.minutePreset || "", 10);
          const active = preset === minuteValue;
          button.classList.toggle("btn-primary", active);
          button.classList.toggle("text-primary-content", active);
          button.classList.toggle("btn-outline", !active);
        });
      };

      const setMinutes = (value) => {
        const minuteValue = clamp(Number.isFinite(value) ? value : min);
        minuteInput.value = minuteValue;
        if (minutePreview) minutePreview.textContent = minuteValue;
        if (minuteDisplay) minuteDisplay.textContent = minuteValue;
        refreshPresetState(minuteValue);
      };

      form.querySelectorAll("[data-minute-adjust]").forEach((button) => {
        button.addEventListener("click", () => {
          const delta = Number.parseInt(button.dataset.minuteAdjust || "0", 10);
          setMinutes(readMinutes() + delta);
        });
      });

      presetButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const preset = Number.parseInt(button.dataset.minutePreset || "", 10);
          setMinutes(preset);
        });
      });

      form.querySelectorAll("[data-setting-toggle]").forEach((toggle) => {
        const statusId = toggle.dataset.statusTarget;
        const status = statusId ? document.getElementById(statusId) : null;
        if (!status) return;

        const refresh = () => {
          const enabled = toggle.checked;
          status.textContent = enabled ? "ON" : "OFF";
          status.classList.toggle("badge-success", enabled);
          status.classList.toggle("badge-ghost", !enabled);
        };

        toggle.addEventListener("change", refresh);
        refresh();
      });

      setMinutes(readMinutes());
    };

    document.addEventListener("turbo:load", bindSettingsUI);
    document.addEventListener("DOMContentLoaded", bindSettingsUI);
  })();
</script>
