<% content_for :title, t("settings.page_title") %>

<div class="max-w-5xl mx-auto">
  <div class="mb-6">
    <h1 class="page-title text-base-content mb-2"><%= t("settings.page_title") %></h1>
    <p class="text-base-content/60"><%= t("settings.page_subtitle") %></p>
  </div>

  <div class="card-modern-static">
    <div class="card-body p-6 md:p-8">
      <%= form_with model: @user, url: setting_path, method: :patch, local: true, class: "space-y-6", data: { settings_form: true } do |form| %>
        <%= form.hidden_field :default_game_minutes, data: { minute_input: true } %>

        <section class="rounded-2xl border border-base-300 bg-base-100 p-5 md:p-6">
          <div class="mb-4">
            <h2 class="text-2xl font-bold text-base-content"><%= t("settings.profile.title", default: "ÌîÑÎ°úÌïÑ") %></h2>
            <p class="text-base-content/60 mt-1"><%= t("settings.profile.description", default: "Îã§Î•∏ ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌëúÏãúÎêòÎäî Ïù¥Î¶ÑÏûÖÎãàÎã§.") %></p>
          </div>

          <div class="flex items-center gap-4">
            <% if @user.avatar_url.present? %>
              <div class="avatar">
                <div class="w-16 rounded-full">
                  <img src="<%= @user.avatar_url %>" alt="<%= @user.display_name %>" />
                </div>
              </div>
            <% else %>
              <div class="avatar placeholder">
                <div class="bg-primary text-primary-content rounded-full w-16">
                  <span class="text-2xl"><%= @user.display_name[0].upcase %></span>
                </div>
              </div>
            <% end %>
            <div class="flex-1">
              <label class="label" for="user_nickname">
                <span class="label-text font-semibold"><%= t("settings.profile.nickname_label", default: "ÌëúÏãú Ïù¥Î¶Ñ") %></span>
              </label>
              <%= form.text_field :nickname,
                  required: true,
                  placeholder: t("settings.profile.nickname_placeholder", default: "ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"),
                  class: "input input-bordered w-full" %>
            </div>
          </div>
          <p class="text-sm text-base-content/50 mt-2"><%= t("settings.profile.email_info", default: "Ïù¥Î©îÏùº: %{email}") % { email: @user.email } %></p>
        </section>

        <section class="rounded-2xl border border-base-300 bg-base-100 p-5 md:p-6">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h2 class="text-2xl font-bold text-base-content"><%= t("settings.game_time.title") %></h2>
              <p class="text-base-content/60 mt-1"><%= t("settings.game_time.description") %></p>
            </div>
            <div class="badge badge-neutral badge-lg gap-1 shrink-0">
              <%= t("settings.game_time.current_default", minutes: @user.default_game_minutes) %>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4">
            <div class="rounded-xl border border-base-300 bg-base-200/40 p-4">
              <p class="font-semibold text-base-content mb-3"><%= t("settings.game_time.base_minutes") %></p>

              <div class="join w-full">
                <button type="button" class="btn btn-outline join-item px-4" data-minute-adjust="-1">-1</button>
                <button type="button" class="btn btn-outline join-item px-4" data-minute-adjust="1">+1</button>
                <div class="join-item btn btn-outline flex-1 cursor-default pointer-events-none bg-base-100 justify-center gap-1 normal-case">
                  <span data-minute-display class="text-3xl md:text-4xl font-black tabular-nums leading-none"><%= @user.default_game_minutes %></span>
                  <span class="text-sm text-base-content/60 font-semibold"><%= t("settings.game_time.minutes_unit") %></span>
                </div>
              </div>

              <p class="text-sm text-base-content/60 mt-3"><%= t("settings.game_time.allowed_range", min: User::MIN_GAME_MINUTES, max: User::MAX_GAME_MINUTES) %></p>
              <% if @user.errors[:default_game_minutes].any? %>
                <p class="text-error text-sm mt-2"><%= @user.errors[:default_game_minutes].join(", ") %></p>
              <% end %>
            </div>

            <div class="rounded-xl border border-base-300 bg-base-200/40 p-4">
              <p class="font-semibold text-base-content mb-3"><%= t("settings.game_time.quick_select") %></p>
              <div class="flex flex-wrap gap-2">
                <% [6, 7, 8, 9, 10, 11, 12].each do |minute| %>
                  <button type="button" class="btn btn-outline" data-minute-preset="<%= minute %>">
                    <%= t("settings.game_time.minute_option", minutes: minute) %>
                  </button>
                <% end %>
              </div>
              <p class="text-sm text-base-content/60 mt-3"><%= t("settings.game_time.quick_select_hint") %></p>
            </div>
          </div>
        </section>

        <section class="rounded-2xl border border-base-300 bg-base-100 p-5 md:p-6">
          <div class="mb-4">
            <h3 class="text-xl font-bold"><%= t("settings.voice.title") %></h3>
            <p class="text-base-content/60 mt-1"><%= t("settings.voice.description") %></p>
          </div>

          <% selected_voice_rate = @user.voice_announcement_rate.to_f.round(1) %>
          <% selected_voice_rate = User::DEFAULT_VOICE_ANNOUNCEMENT_RATE unless User::VOICE_ANNOUNCEMENT_RATES.include?(selected_voice_rate) %>

          <div class="grid grid-cols-1 gap-4">
            <% announcements_enabled = @user.scoreboard_sound_enabled && @user.voice_announcement_enabled %>
            <%= hidden_field_tag "user[announcements_enabled]", announcements_enabled ? "1" : "0", data: { announcements_hidden: true } %>
            <%= hidden_field_tag "user[scoreboard_sound_enabled]", announcements_enabled ? "1" : "0", data: { announcements_hidden: true } %>
            <%= hidden_field_tag "user[voice_announcement_enabled]", announcements_enabled ? "1" : "0", data: { announcements_hidden: true } %>

            <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-center justify-between gap-4 hover:border-primary/40 transition-colors">
              <div>
                <p class="font-semibold"><%= t("settings.voice.announcements_title") %></p>
                <p class="text-sm text-base-content/60"><%= t("settings.voice.announcements_description") %></p>
              </div>
              <div class="flex items-center gap-2">
                <span id="announcements-status" class="badge badge-sm"><%= t("common.on") %></span>
                <input
                  type="checkbox"
                  class="toggle toggle-primary"
                  data-announcements-toggle
                  <%= "checked" if announcements_enabled %>>
              </div>
            </label>

            <div class="rounded-xl border border-base-300 bg-base-200/30 p-4">
              <p class="font-semibold"><%= t("settings.voice.rate_title") %></p>
              <p class="text-sm text-base-content/60 mt-1"><%= t("settings.voice.rate_description") %></p>

              <div class="mt-3 flex flex-wrap items-center gap-2">
                <% User::VOICE_ANNOUNCEMENT_RATES.each do |rate| %>
                  <% label = case rate
                            when 1.0 then t("settings.voice.rate_normal")
                            when 1.1 then t("settings.voice.rate_fast")
                            else t("settings.voice.rate_slow")
                            end %>
                  <label class="cursor-pointer">
                    <%= form.radio_button :voice_announcement_rate, rate, checked: (selected_voice_rate == rate), class: "peer sr-only" %>
                    <span class="inline-flex items-center rounded-lg border border-base-300 bg-base-100 px-3 py-2 text-sm font-semibold transition-all peer-checked:border-primary peer-checked:bg-primary peer-checked:text-primary-content">
                      <%= label %>
                    </span>
                  </label>
                <% end %>
                <button type="button" class="btn btn-sm btn-outline ml-1" data-voice-rate-test>
                  <%= t("settings.voice.test_button") %>
                </button>
              </div>
              <p class="text-xs text-base-content/50 mt-2"><%= t("settings.voice.test_description") %></p>
            </div>
          </div>
        </section>

        <section class="rounded-2xl border border-base-300 bg-base-100 p-5 md:p-6">
          <div class="mb-4">
            <h3 class="text-xl font-bold"><%= t("settings.language.title") %></h3>
            <p class="text-base-content/60 mt-1"><%= t("settings.language.description") %></p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            <% selected_locale = @user.preferred_locale.presence || User::DEFAULT_LOCALE %>
            <% available_locale_options.each do |label, code| %>
              <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-center gap-3 hover:border-primary/40 transition-colors">
                <%= form.radio_button :preferred_locale, code, checked: (selected_locale == code), class: "radio radio-primary" %>
                <div class="min-w-0">
                  <p class="font-semibold truncate"><%= label %></p>
                  <p class="text-xs text-base-content/50 uppercase"><%= code %></p>
                </div>
              </label>
            <% end %>
          </div>
        </section>

        <section class="rounded-2xl border border-base-300 bg-base-100 p-5 md:p-6">
          <div class="mb-4">
            <h3 class="text-xl font-bold"><%= t("settings.possession.title") %></h3>
            <p class="text-base-content/60 mt-1"><%= t("settings.possession.description") %></p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-start gap-3 hover:border-primary/40 transition-colors">
              <%= form.radio_button :possession_switch_pattern, "fiba", class: "radio radio-primary mt-1" %>
              <div>
                <p class="font-semibold"><%= t("settings.possession.option_fiba.title") %></p>
                <p class="text-sm text-base-content/60 mt-1"><%= t("settings.possession.option_fiba.description") %></p>
              </div>
            </label>

            <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-start gap-3 hover:border-primary/40 transition-colors">
              <%= form.radio_button :possession_switch_pattern, "nba", class: "radio radio-primary mt-1" %>
              <div>
                <p class="font-semibold"><%= t("settings.possession.option_nba.title") %></p>
                <p class="text-sm text-base-content/60 mt-1"><%= t("settings.possession.option_nba.description") %></p>
              </div>
            </label>

            <label class="cursor-pointer rounded-xl border border-base-300 bg-base-200/30 p-4 flex items-start gap-3 hover:border-primary/40 transition-colors">
              <%= form.radio_button :possession_switch_pattern, "club", class: "radio radio-primary mt-1" %>
              <div>
                <p class="font-semibold"><%= t("settings.possession.option_club.title") %></p>
                <p class="text-sm text-base-content/60 mt-1"><%= t("settings.possession.option_club.description") %></p>
              </div>
            </label>
          </div>
        </section>

        <div class="flex items-center gap-3">
          <%= form.submit t("common.save"), class: "btn btn-primary px-7" %>
          <%= link_to t("common.cancel"), clubs_path, class: "btn btn-ghost" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Ïó∞Í≤∞Îêú ÏÜåÏÖú Í≥ÑÏ†ï -->
  <% if current_user.identities.any? %>
    <div class="card-modern-static mt-6">
      <div class="card-body p-6 md:p-8">
        <h2 class="text-xl font-bold text-base-content mb-4">Ïó∞Í≤∞Îêú ÏÜåÏÖú Í≥ÑÏ†ï</h2>
        <div class="space-y-3">
          <% current_user.identities.each do |identity| %>
            <div class="flex items-center gap-3 p-3 rounded-lg bg-base-200/50">
              <% case identity.provider %>
              <% when "kakao" %>
                <span class="text-xl">üí¨</span>
                <span class="font-medium">Ïπ¥Ïπ¥Ïò§</span>
              <% when "naver" %>
                <span class="text-xl font-bold text-green-500">N</span>
                <span class="font-medium">ÎÑ§Ïù¥Î≤Ñ</span>
              <% when "google_oauth2" %>
                <span class="text-xl">G</span>
                <span class="font-medium">Google</span>
              <% end %>
              <span class="text-sm text-base-content/50 ml-auto"><%= identity.email || identity.name %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
  (() => {
    const bindSettingsUI = () => {
      const form = document.querySelector("[data-settings-form]");
      if (!form || form.dataset.settingsUiBound === "true") return;
      form.dataset.settingsUiBound = "true";
      const announcementsOnLabel = "<%= j t("common.on") %>";
      const announcementsOffLabel = "<%= j t("common.off") %>";
      const unsupportedSpeechAlert = "<%= j t("settings.voice.unsupported_browser_alert") %>";
      const speechLocaleByPreferredLocale = <%= raw(User::SPEECH_LOCALE_BY_PREFERRED_LOCALE.to_json) %>;
      const voiceTestTextByLocale = <%= raw({
        "ko" => I18n.t("settings.voice.preview_text", locale: :ko),
        "ja" => I18n.t("settings.voice.preview_text", locale: :ja),
        "en" => I18n.t("settings.voice.preview_text", locale: :en),
        "zh" => I18n.t("settings.voice.preview_text", locale: :zh),
        "fr" => I18n.t("settings.voice.preview_text", locale: :fr),
        "es" => I18n.t("settings.voice.preview_text", locale: :es),
        "it" => I18n.t("settings.voice.preview_text", locale: :it),
        "pt" => I18n.t("settings.voice.preview_text", locale: :pt),
        "tl" => I18n.t("settings.voice.preview_text", locale: :tl),
        "de" => I18n.t("settings.voice.preview_text", locale: :de)
      }.to_json) %>;

      const minuteInput = form.querySelector("[data-minute-input]");
      const minutePreview = form.querySelector("[data-minute-preview]");
      const minuteDisplay = form.querySelector("[data-minute-display]");
      const presetButtons = Array.from(form.querySelectorAll("[data-minute-preset]"));
      if (!minuteInput) return;

      const min = <%= User::MIN_GAME_MINUTES %>;
      const max = <%= User::MAX_GAME_MINUTES %>;

      const clamp = (value) => Math.max(min, Math.min(max, value));
      const readMinutes = () => clamp(Number.parseInt(minuteInput.value || `${min}`, 10) || min);

      const refreshPresetState = (minuteValue) => {
        presetButtons.forEach((button) => {
          const preset = Number.parseInt(button.dataset.minutePreset || "", 10);
          const active = preset === minuteValue;
          button.classList.toggle("btn-primary", active);
          button.classList.toggle("text-primary-content", active);
          button.classList.toggle("btn-outline", !active);
        });
      };

      const setMinutes = (value) => {
        const minuteValue = clamp(Number.isFinite(value) ? value : min);
        minuteInput.value = minuteValue;
        if (minutePreview) minutePreview.textContent = minuteValue;
        if (minuteDisplay) minuteDisplay.textContent = minuteValue;
        refreshPresetState(minuteValue);
      };

      form.querySelectorAll("[data-minute-adjust]").forEach((button) => {
        button.addEventListener("click", () => {
          const delta = Number.parseInt(button.dataset.minuteAdjust || "0", 10);
          setMinutes(readMinutes() + delta);
        });
      });

      presetButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const preset = Number.parseInt(button.dataset.minutePreset || "", 10);
          setMinutes(preset);
        });
      });

      const announcementsToggle = form.querySelector("[data-announcements-toggle]");
      const announcementsStatus = document.getElementById("announcements-status");
      const announcementHiddenInputs = Array.from(form.querySelectorAll("[data-announcements-hidden]"));

      const refreshAnnouncementsState = () => {
        if (!announcementsToggle) return;
        const enabled = announcementsToggle.checked;

        if (announcementsStatus) {
          announcementsStatus.textContent = enabled ? announcementsOnLabel : announcementsOffLabel;
          announcementsStatus.classList.toggle("badge-success", enabled);
          announcementsStatus.classList.toggle("badge-ghost", !enabled);
        }

        announcementHiddenInputs.forEach((input) => {
          input.value = enabled ? "1" : "0";
        });
      };

      if (announcementsToggle) {
        announcementsToggle.addEventListener("change", refreshAnnouncementsState);
      }
      refreshAnnouncementsState();

      const voiceRateTestButton = form.querySelector("[data-voice-rate-test]");
      if (voiceRateTestButton) {
        const selectedPreferredLocale = () => {
          const checked = form.querySelector('input[name="user[preferred_locale]"]:checked');
          const value = String(checked?.value || "<%= j(User::DEFAULT_LOCALE) %>").toLowerCase();
          return Object.prototype.hasOwnProperty.call(speechLocaleByPreferredLocale, value) ? value : "<%= j(User::DEFAULT_LOCALE) %>";
        };

        const selectedVoiceRate = () => {
          const checked = form.querySelector('input[name="user[voice_announcement_rate]"]:checked');
          const parsed = Number.parseFloat(checked?.value || "<%= User::DEFAULT_VOICE_ANNOUNCEMENT_RATE %>");
          return Number.isFinite(parsed) ? parsed : <%= User::DEFAULT_VOICE_ANNOUNCEMENT_RATE %>;
        };

        voiceRateTestButton.addEventListener("click", () => {
          if (!("speechSynthesis" in window)) {
            alert(unsupportedSpeechAlert);
            return;
          }

          window.speechSynthesis.cancel();

          const locale = selectedPreferredLocale();
          const voiceLang = speechLocaleByPreferredLocale[locale] || speechLocaleByPreferredLocale["ko"];
          const previewText = voiceTestTextByLocale[locale] || voiceTestTextByLocale["ko"];

          const utterance = new SpeechSynthesisUtterance(previewText);
          utterance.lang = voiceLang;
          utterance.rate = selectedVoiceRate();
          utterance.volume = 1.0;
          utterance.pitch = 1.0;

          const voices = window.speechSynthesis.getVoices();
          const langPrefix = String(voiceLang || "").toLowerCase().split("-")[0];
          const matchingVoice = voices.find((voice) => String(voice.lang || "").toLowerCase().startsWith(langPrefix));
          if (matchingVoice) utterance.voice = matchingVoice;

          window.speechSynthesis.speak(utterance);
        });
      }

      setMinutes(readMinutes());
    };

    document.addEventListener("turbo:load", bindSettingsUI);
    document.addEventListener("DOMContentLoaded", bindSettingsUI);
  })();
</script>
