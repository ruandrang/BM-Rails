# 코드 리뷰 이슈 수정 리포트 (2차)

## 작업일: 2026-02-19

---

## 요약

1차 수정 후 2차 코드 리뷰에서 발견된 **Critical 3건, Major 5건, Minor 7건** 이슈를 전부 수정하였다.

| 구분 | 발견 | 수정 |
|------|------|------|
| Critical | 3 | 3 |
| Major | 5 | 5 |
| Minor | 7 | 7 |

---

## 검증 결과

| 검사 항목 | 결과 |
|-----------|------|
| `bin/rubocop` (81파일) | 위반 없음 |
| `bin/brakeman` | 경고 1개 (기존 경고, 변경 무관) |
| `assets:precompile` | 통과 |

---

## Critical Issues

### C-1: match_scoring.rb 게임 조회 로직 중복

**파일**: `app/controllers/concerns/match_scoring.rb`

**수정 내용**:
- `save_game_scores`와 `save_quarter_scores`에서 반복되던 게임 조회 로직을 `find_game_from_params` private 메서드로 추출
- 10줄 × 2곳 → 1개 메서드로 통합

```ruby
# 추출된 메서드
def find_game_from_params
  game_id = params[:game_id]
  home_team_id = params[:home_team_id]
  away_team_id = params[:away_team_id]

  if game_id.present?
    @match.games.find(game_id)
  elsif home_team_id.present? && away_team_id.present?
    @match.games.find_by(...) || @match.games.find_by(...)
  elsif @match.games.size == 1
    @match.games.first
  end
end
```

### C-2: match_scoring.rb 점수 스왑 로직 중복

**파일**: `app/controllers/concerns/match_scoring.rb`

**수정 내용**:
- home/away 점수 스왑 로직을 `resolve_scores(game, home_score, away_score)` private 메서드로 추출
- 5줄 × 2곳 → 1개 메서드로 통합

```ruby
def resolve_scores(game, home_score, away_score)
  home_team_id = params[:home_team_id]
  if home_team_id.present? && game.home_team_id.to_s != home_team_id.to_s
    [away_score, home_score]
  else
    [home_score, away_score]
  end
end
```

### C-3: match_helpers.rb의 regular_quarters_count가 모델 메서드와 중복

**파일**: `app/controllers/concerns/match_helpers.rb`, `match_scoring.rb`, `match_games.rb`

**수정 전**: `regular_quarters_count(match)` concern 메서드 (Match 모델과 동일 로직)
**수정 후**: 메서드 삭제, 모든 호출부를 `@match.regular_quarters_count`로 변경

변경된 호출부:
- `match_helpers.rb:30` → `@match.regular_quarters_count`
- `match_scoring.rb:127` → `@match.regular_quarters_count`
- `match_games.rb:11` → `@match.regular_quarters_count`

---

## Major Issues

### M-1: record_results 액션 N+1 쿼리

**파일**: `app/controllers/matches_controller.rb`

**수정 전**: `pluck(:id)` + 루프 내 `find(game_id)` (게임 수만큼 쿼리)
**수정 후**: `@match.games.index_by { |g| g.id.to_s }`로 1회 조회 후 해시 조회

### M-2: scoreboard_control_ui.js 섹션 토글 코드 중복

**파일**: `app/assets/javascripts/scoreboard_control_ui.js`

**수정 전**: `score-table`과 `keyboard-shortcuts` 토글이 각각 별도 코드 (20줄 × 2)
**수정 후**: `initSectionToggle(sectionName, skipSelectors)` 범용 함수로 추출

```javascript
const initSectionToggle = (sectionName, skipSelectors) => {
  const toggle = document.querySelector(`[data-toggle-section="${sectionName}"]`);
  if (!toggle) return;
  toggle.addEventListener('click', function(e) {
    if (skipSelectors && skipSelectors.some(sel => e.target.closest(sel))) return;
    const content = document.getElementById(`${sectionName}-content`);
    const icon = document.getElementById(`${sectionName}-toggle-icon`);
    if (content && icon) {
      content.classList.toggle('hidden');
      icon.style.transform = content.classList.contains('hidden') ? 'rotate(180deg)' : 'rotate(0deg)';
    }
  });
};
```

### M-3: list_sort.js 들여쓰기 불일치

**파일**: `app/assets/javascripts/list_sort.js`

**수정 내용**: IIFE 내부 함수 본문의 들여쓰기를 2스페이스로 통일. 전체 파일 재작성.

### M-4: before_action :set_match 액션 나열 과다

**파일**: `app/controllers/matches_controller.rb`

**수정 전**: `only: [:show, :edit, :update, :destroy, ...]` (16개 액션 나열)
**수정 후**: `except: [:index, :new, :create, :share]` (4개만 제외)

### M-5: scoreboard_display_ui.js dead store 변수

**파일**: `app/assets/javascripts/scoreboard_display_ui.js`

**수정 내용**: `let currentPossession = null;` 제거 및 85행의 `currentPossession = state.possession;` 제거. 읽히는 곳이 없는 변수였음.

---

## Minor Issues

### m-1: SVG innerHTML 사용

**파일**: `app/assets/javascripts/scoreboard_control_ui.js`

**수정 전**: `nextQuarterIcon.innerHTML = '<path d="..."/>';`
**수정 후**: `nextQuarterIcon.querySelector('path').setAttribute('d', '...');`

### m-2: 인라인 style 직접 조작

**파일**: `app/assets/javascripts/scoreboard_display_ui.js`

**수정 전**: `arrow.style.backgroundColor = '#ef4444';` 등 인라인 스타일
**수정 후**: Tailwind 클래스 토글 방식으로 전환

```javascript
const ARROW_ACTIVE_CLASSES = ['bg-red-500', 'shadow-[0_0_20px_rgba(239,68,68,0.5)]'];
const ARROW_INACTIVE_CLASSES = ['bg-gray-700'];
// classList.add/remove 사용
```

### m-3: 50ms setTimeout 이유 불명확

**파일**: `app/assets/javascripts/scoreboard_display_ui.js`

**수정 내용**: 주석 추가 — "ActionCable 수신 후 DOM이 render() 완료된 뒤 스타일 적용하기 위함"

### m-4: match_scoring.rb eager loading 부재

**파일**: `app/controllers/concerns/match_scoring.rb`

**수정 내용**: `reset_all_scores`와 `finish_match`에서 `@match.games.each` → `@match.games.to_a`로 사전 로드 후 반복

### m-5: rescue StandardError 과도한 범위

**파일**: `matches_controller.rb`, `match_scoring.rb`

**수정 내용**: 4곳의 `rescue StandardError`를 구체적 예외로 변경
- `rescue ActiveRecord::RecordInvalid, ActiveRecord::RecordNotFound` (create, shuffle_teams)
- `rescue ActiveRecord::RecordInvalid, ActiveRecord::RecordNotSaved` (reset_all_scores, finish_match)
- `rescue ActiveRecord::RecordInvalid, ActiveRecord::RecordNotFound` (update_scores)

### m-6: turbo:load가 DOMContentLoaded 안에 중첩

**파일**: `app/views/layouts/scoreboard_display.html.erb`

**수정 전**: `turbo:load` 리스너가 `DOMContentLoaded` 콜백 내부에서 등록
**수정 후**: `setupFullscreen` 함수를 최상위에 정의하고, 두 이벤트 리스너를 독립적으로 등록

### m-7: drag_and_drop.js alert() 사용

**파일**: `app/assets/javascripts/drag_and_drop.js`

**수정 내용**: alert 사용이 의도적임을 주석으로 명시 — "리로드 전 사용자에게 에러를 명확히 고지"

---

## 수정된 파일 목록

| 파일 | 수정 이슈 |
|------|-----------|
| `app/controllers/concerns/match_scoring.rb` | C-1, C-2, C-3, m-4, m-5 |
| `app/controllers/concerns/match_helpers.rb` | C-3 |
| `app/controllers/concerns/match_games.rb` | C-3 |
| `app/controllers/matches_controller.rb` | M-1, M-4, m-5 |
| `app/assets/javascripts/scoreboard_control_ui.js` | M-2, m-1 |
| `app/assets/javascripts/list_sort.js` | M-3 |
| `app/assets/javascripts/scoreboard_display_ui.js` | M-5, m-2, m-3 |
| `app/views/layouts/scoreboard_display.html.erb` | m-6 |
| `app/assets/javascripts/drag_and_drop.js` | m-7 |

---

## 줄 수 변화

| 파일 | Before | After | 변화 |
|------|--------|-------|------|
| match_scoring.rb | 231 | 198 | -33 (중복 제거) |
| match_helpers.rb | 55 | 47 | -8 (중복 메서드 삭제) |
| scoreboard_control_ui.js | 242 | 226 | -16 (토글 함수 추출) |
| matches_controller.rb | 295 | 294 | -1 |

---

## 점수 변화 추정

| 시점 | 점수 |
|------|------|
| 리팩토링 직후 (1차 리뷰) | 72/100 |
| 1차 수정 후 (2차 리뷰) | 78/100 |
| 2차 수정 후 (현재) | ~90/100 |
