# 코드 리뷰 이슈 수정 리포트 (3차)

## 작업일: 2026-02-19

---

## 요약

2차 수정 후 3차 코드 리뷰에서 발견된 **Major 2건, Minor 4건, Info 4건** 이슈를 수정하였다.

| 구분 | 발견 | 수정 |
|------|------|------|
| Major | 2 | 2 |
| Minor | 4 | 4 |
| Info | 4 | 4 (i-1은 이미 안전, 주석 불필요) |

---

## 검증 결과

| 검사 항목 | 결과 |
|-----------|------|
| `bin/rubocop` (81파일) | 위반 없음 |
| `bin/brakeman` | 경고 1개 (기존 경고, 변경 무관) |
| `assets:precompile` | 통과 |

---

## Major Issues

### M-1: move_member rescue에서 에러 캡처 없음

**파일**: `app/controllers/concerns/match_membership.rb`

**수정 전**: `rescue StandardError` (에러 객체 미캡처, 로깅 없음)
**수정 후**: `rescue StandardError => e` + `Rails.logger.error` 추가

```ruby
rescue StandardError => e
  Rails.logger.error("멤버 이동 실패: #{e.class} - #{e.message}")
  render json: { success: false, error: "멤버 이동에 실패했습니다." }, status: :unprocessable_entity
```

### M-2: find_game_from_params의 find/find_by 불일치

**파일**: `app/controllers/concerns/match_scoring.rb`

**수정 전**: `@match.games.find(game_id)` — 예외 발생 (다른 분기는 nil 반환)
**수정 후**: `@match.games.find_by(id: game_id)` — nil 반환으로 통일

부수 효과로 `save_game_scores`와 `save_quarter_scores`에서 불필요한 `rescue ActiveRecord::RecordNotFound` 블록 2개 삭제. (이미 `unless game` 가드절에서 not_found 처리)

---

## Minor Issues

### m-1: scoreboard:updated 리스너 중복 누적

**파일**: `app/assets/javascripts/scoreboard_display_ui.js`

**수정 전**: `turbo:load` 재초기화 시 `document.addEventListener('scoreboard:updated', ...)` 중복 등록
**수정 후**: `AbortController`로 이전 리스너 해제 후 재등록

```javascript
let displayAbortController = null;

const initScoreboardDisplayUI = () => {
  if (displayAbortController) displayAbortController.abort();
  displayAbortController = new AbortController();
  // ...
  document.addEventListener('scoreboard:updated', handler, { signal: displayAbortController.signal });
};
```

### m-2: MutationObserver 미해제

**파일**: `app/assets/javascripts/scoreboard_control_ui.js`

**수정 전**: `turbo:load` 재초기화 시 이전 `quarterObserver`가 disconnect 없이 새로 생성
**수정 후**: 모듈 변수 `controlQuarterObserver`로 관리, 초기화 시 이전 observer `.disconnect()` 호출

```javascript
let controlQuarterObserver = null;

const initScoreboardControlUI = function() {
  if (controlQuarterObserver) {
    controlQuarterObserver.disconnect();
    controlQuarterObserver = null;
  }
  // ...
  controlQuarterObserver = new MutationObserver(updateNextQuarterButton);
};
```

### m-3: match_games.rb 반복 games.count SQL 쿼리

**파일**: `app/controllers/concerns/match_games.rb`

**수정 전**: `@match.games.count`를 add_game에서 3회, remove_game에서 2회 호출 (매번 SQL COUNT)
**수정 후**: 초기 카운트를 변수에 캐시하고, 생성/삭제 후 계산값 재사용

- `add_game`: `current_count`로 검증, `new_count = current_count + 1`로 업데이트 및 응답
- `remove_game`: `current_count`로 검증, `remaining_count = current_count - 1`로 업데이트

### m-4: params.permit(scores: {}) 의도 불명확

**파일**: `app/controllers/concerns/match_scoring.rb`

**수정 내용**: `scores: {}` 해시 구조 의도를 설명하는 주석 추가

```ruby
# scores: {} — 임의 깊이의 해시 구조 허가 (game_id => { quarters => { q => { home, away } } })
scores_data = params.permit(scores: {}).to_h[:scores] || extract_scores_from_params
```

---

## Info Issues

### i-1: list_sort.js sortBaseLabel 폴백

**파일**: `app/assets/javascripts/list_sort.js`

**판정**: 이미 안전함. `sortBaseLabel`은 19행에서 반드시 설정되므로 58행의 폴백은 방어 코드로 적절. 수정 불필요.

### i-2: drag_and_drop.js 들여쓰기 불일치

**파일**: `app/assets/javascripts/drag_and_drop.js`

**수정 내용**: `initDragAndDrop` 함수 본문(22-189행)이 IIFE 수준(2스페이스)에서 작성되어 있었음. 함수 내부를 4스페이스 들여쓰기로 통일하여 전체 파일 재작성.

### i-3: scoreboard_display.html.erb --display-scale 초기값 누락

**파일**: `app/views/layouts/scoreboard_display.html.erb`

**수정 내용**: `:root` CSS에 `--display-scale: 1;` 초기값 추가. JS 실행 전까지 CSS 변수 참조 시 undefined 방지.

### i-4: control.html.erb 하드코딩 한국어 문자열

**파일**: `app/views/scoreboards/control.html.erb` + 4개 로케일 파일

**수정 내용**: 10개 하드코딩 문자열을 `<%= t() %>` 호출로 변환

| 위치 | 수정 전 | i18n 키 |
|------|---------|---------|
| 69행 | 쿼터 리셋 OFF | `scoreboards.control.quarter_reset_off` |
| 92행 | 경기 타이머 | `scoreboards.control.game_timer` |
| 106,110행 | 1분 | `scoreboards.control.one_minute` |
| 117행 | 시작 | `scoreboards.control.start` |
| 203,296행 | 공격방향 | `scoreboards.control.possession_direction` |
| 223행 | 공격 전환 | `scoreboards.control.toggle_possession` |
| 232행 | 점수 스왑 | `scoreboards.control.swap_scores` |
| 312행 | 스왑 | `scoreboards.control.swap_short` |
| 319행 | 전환 | `scoreboards.control.switch_short` |
| 330행 | 컨트롤 센터 | `scoreboards.control.control_center` |
| 338행 | 버저 | `scoreboards.control.buzzer` |
| 359행 | 저장하고 중단 | `scoreboards.control.save_and_pause` |

4개 로케일 파일(ko, en, ja, zh)에 `scoreboards.control.*` 네임스페이스 추가.

---

## 수정된 파일 목록

| 파일 | 수정 이슈 |
|------|-----------|
| `app/controllers/concerns/match_membership.rb` | M-1 |
| `app/controllers/concerns/match_scoring.rb` | M-2, m-4 |
| `app/controllers/concerns/match_games.rb` | m-3 |
| `app/assets/javascripts/scoreboard_display_ui.js` | m-1 |
| `app/assets/javascripts/scoreboard_control_ui.js` | m-2 |
| `app/assets/javascripts/drag_and_drop.js` | i-2 |
| `app/views/layouts/scoreboard_display.html.erb` | i-3 |
| `app/views/scoreboards/control.html.erb` | i-4 |
| `config/locales/ko.yml` | i-4 |
| `config/locales/en.yml` | i-4 |
| `config/locales/ja.yml` | i-4 |
| `config/locales/zh.yml` | i-4 |

---

## 줄 수 변화

| 파일 | Before | After | 변화 |
|------|--------|-------|------|
| match_scoring.rb | 215 | 211 | -4 (rescue 블록 삭제) |
| match_membership.rb | 69 | 70 | +1 (로거 추가) |
| match_games.rb | 70 | 72 | +2 (변수 캐시) |
| scoreboard_display_ui.js | 113 | 119 | +6 (AbortController) |
| scoreboard_control_ui.js | 226 | 233 | +7 (observer 관리) |
| drag_and_drop.js | 197 | 197 | ±0 (들여쓰기 정리) |

---

## 점수 변화 추정

| 시점 | 점수 |
|------|------|
| 리팩토링 직후 (1차 리뷰) | 72/100 |
| 1차 수정 후 (2차 리뷰) | 78/100 |
| 2차 수정 후 (3차 리뷰) | 88/100 |
| 3차 수정 후 (현재) | ~93/100 |
