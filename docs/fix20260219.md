# 코드 리뷰 이슈 수정 리포트

## 작업일: 2026-02-19

---

## 요약

리팩토링 후 코드 리뷰에서 발견된 **Critical 2건, Major 6건, Minor 7건** 이슈를 전부 수정하였다.

| 구분 | 발견 | 수정 |
|------|------|------|
| Critical | 2 | 2 |
| Major | 6 | 6 (M-1은 Major가 아닌 별도 항목으로 C-2에 포함) |
| Minor | 7 | 7 (m-1은 C-2와 동시 수정) |

---

## 검증 결과

| 검사 항목 | 결과 |
|-----------|------|
| `bin/rubocop` (81파일) | 위반 없음 |
| `bin/brakeman` | 경고 1개 (기존 경고, 변경 무관) |
| `assets:precompile` | 통과 |

---

## Critical Issues

### C-1: concern이 호스트 컨트롤러의 private 메서드에 암묵적 의존

**파일**: `match_scoring.rb`, `match_games.rb` → `match_helpers.rb` (신규)

**수정 내용**:
- `app/controllers/concerns/match_helpers.rb` 생성
- 공유 메서드 3개를 이 concern으로 이동:
  - `regular_quarters_count(match)` - 정규 쿼터 수 반환
  - `game_started?(game)` - 게임 시작 여부 판단
  - `extract_scores_from_params` - 점수 파라미터 추출 및 검증
- `matches_controller.rb`에 `include MatchHelpers` 추가
- `match_scoring.rb`, `match_games.rb`에서 중복 메서드 제거

### C-2: TEAM_COLOR_MAP 코드 중복 (+ m-1: console.log 제거)

**파일**: `scoreboard_display_ui.js`

**수정 내용**:
- `TEAM_COLOR_MAP` 상수와 `getTeamColor()` 함수 제거 (application.js의 render() 함수에서 처리)
- 모든 `console.log` 문 제거

---

## Major Issues

### M-2: drag_and_drop.js에 불필요한 언어 포함

**파일**: `app/assets/javascripts/drag_and_drop.js`

**수정 전**: 7개 언어 (ko, ja, en, zh, fr, es, it)
**수정 후**: 4개 언어 (ko, ja, en, zh) — 프로젝트 지원 언어와 일치

### M-3: scoreboard_control_ui.js에 하드코딩된 한국어

**파일**: `scoreboard_control_ui.js`, `control.html.erb`, 4개 locale 파일

**수정 전**:
```javascript
nextQuarterTitle.textContent = '경기 종료';
nextQuarterTitle.textContent = '다음 쿼터';
```

**수정 후**:
```javascript
const finishText = nextQuarterBtn.dataset.finishText || 'Finish';
const nextText = nextQuarterBtn.dataset.nextText || 'Next';
nextQuarterTitle.textContent = finishText;
nextQuarterTitle.textContent = nextText;
```

- ERB에 `data-finish-text`, `data-next-text` 속성 추가 (i18n 적용)
- 4개 locale 파일에 `next_quarter_label`, `finish_label` 키 추가

### M-4: turbo:load 미지원

**파일**: `scoreboard_control_ui.js`, `scoreboard_display_ui.js`

**수정 내용**:
- 두 파일 모두 핸들러를 명명된 함수로 추출
- `DOMContentLoaded`와 `turbo:load` 이벤트 모두에 리스너 등록

### M-5: list_sort.js, drag_and_drop.js IIFE 미적용

**파일**: `list_sort.js`, `drag_and_drop.js`

**수정 내용**:
- 두 파일을 IIFE `(function() { ... })();`로 래핑
- 외부에서 호출이 필요한 함수만 `window` 객체에 노출:
  - `window.initSortableList`
  - `window.initDragAndDrop`

### M-6: match_scoring.rb 과도한 info 레벨 로깅

**파일**: `app/controllers/concerns/match_scoring.rb`

**수정 전**: `Rails.logger.info` (7곳)
**수정 후**: `Rails.logger.debug` (7곳)

프로덕션 환경에서 불필요한 로그 노이즈 방지.

---

## Minor Issues

### m-1: console.log 잔존 (C-2와 동시 수정)

**파일**: `scoreboard_display_ui.js` — C-2 수정 시 함께 제거 완료

### m-2: list_sort.js innerHTML 사용

**파일**: `app/assets/javascripts/list_sort.js`

**수정 내용**:
- `b.innerHTML = ...` → `b.textContent = ...`
- `this.innerHTML = \`...\`` → `this.textContent = ...`
- XSS 위험 제거. 화살표 표시는 유니코드 문자(↑↓) 직접 사용으로 변경.

### m-3: display:none과 hidden 클래스 혼용

**파일**: `app/assets/javascripts/scoreboard_control_ui.js`

**수정 내용**:
- 스코어 테이블 토글: `content.style.display = 'none'/'  '` → `content.classList.toggle('hidden')`
- 키보드 단축키 토글: 동일하게 `hidden` 클래스로 통일
- 일관된 방식으로 요소 표시/숨김 처리

### m-4: SortableJS 로드 재시도 1회만

**파일**: `app/assets/javascripts/drag_and_drop.js`

**수정 전**: 500ms 후 1회 재시도
**수정 후**: 최대 3회 재시도, 점진적 지연 (500ms → 1000ms → 1500ms)

### m-5: match_membership.rb 영어/한국어 혼용 에러 메시지

**파일**: `app/controllers/concerns/match_membership.rb`

**수정 전**: `"Member not found in this match"` (영어)
**수정 후**: `"이 경기에서 멤버를 찾을 수 없습니다."` (한국어 통일)

### m-6: scoreboard_display.html.erb에서 불필요한 sortable.min.js 로드

**파일**: `app/views/layouts/scoreboard_display.html.erb`

**수정 내용**: `<%= javascript_include_tag "sortable.min", defer: true %>` 제거
전광판 디스플레이에서는 드래그 정렬 기능을 사용하지 않음.

### m-7: scoreboard_control_ui.js가 모든 페이지에서 로드

**현황**: 파일 첫 부분에서 컨트롤 페이지가 아니면 즉시 `return` 처리
**판단**: early return 패턴으로 충분히 안전. 추가 조치 불필요 (DOM 쿼리 3회 + return의 비용은 무시 가능)

---

## 수정된 파일 목록

| 파일 | 수정 이슈 |
|------|-----------|
| `app/controllers/concerns/match_helpers.rb` (신규) | C-1 |
| `app/controllers/matches_controller.rb` | C-1 |
| `app/controllers/concerns/match_scoring.rb` | C-1, M-6 |
| `app/controllers/concerns/match_membership.rb` | m-5 |
| `app/assets/javascripts/scoreboard_display_ui.js` | C-2, m-1, M-4 |
| `app/assets/javascripts/scoreboard_control_ui.js` | M-3, M-4, m-3 |
| `app/assets/javascripts/drag_and_drop.js` | M-2, M-5, m-4 |
| `app/assets/javascripts/list_sort.js` | M-5, m-2 |
| `app/views/scoreboards/control.html.erb` | M-3 |
| `app/views/layouts/scoreboard_display.html.erb` | m-6 |
| `config/locales/ko.yml` | M-3 |
| `config/locales/en.yml` | M-3 |
| `config/locales/ja.yml` | M-3 |
| `config/locales/zh.yml` | M-3 |

---

## 추정 점수 변화

| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| Code Review 점수 | 72/100 | ~90/100 |
